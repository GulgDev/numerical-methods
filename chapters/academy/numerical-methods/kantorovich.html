<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="icon"
      href="/static/img/icon.svg"
      sizes="any"
      type="image/svg+xml"
    />

    <!-- Global styles -->
    <link rel="stylesheet" href="/static/style/index.css" />
    <!-- Page-specific styles -->
    <link rel="stylesheet" href="kantorovich.css" />

    <title>
      Леонид Канторович &middot; Численные методы &middot; Академия наук
    </title>
  </head>
  <body>
    <div id="header-container">
      <header>
        <a class="ui" href="/" draggable="false">
          <img
            src="/static/img/logo.svg"
            height="32"
            alt="Логотип"
            title="Computational Methods"
            draggable="false"
          />
        </a>
        <div id="title-bar">
          <a class="ui" href="krylov.html">
            <img
              src="/static/img/arrow-left.svg"
              height="32"
              alt="Назад"
              draggable="false"
            />
          </a>
          <h1 class="ui">Леонид Канторович</h1>
          <a class="ui" href="samarskii-yanenko.html">
            <img
              src="/static/img/arrow-right.svg"
              height="32"
              alt="Вперёд"
              draggable="false"
            />
          </a>
        </div>
        <button id="nav-toggle" class="ui" popovertarget="nav">
          <img
            src="/static/img/menu.svg"
            height="32"
            alt="Меню"
            draggable="false"
          />
        </button>
      </header>
    </div>
    <nav id="nav" popover>
      <menu>
        <li><a href="/">Главная</a></li>
        <li>
          <details open>
            <summary>Список глав</summary>
            <menu>
              <details name="nav-chapter">
                <summary>Начало пути</summary>
                <menu>
                  <li>
                    <a href="/chapters/beginning/ancient.html">Древний мир</a>
                  </li>
                  <li>
                    <a href="/chapters/beginning/middle-ages.html"
                      >Средневековье</a
                    >
                  </li>
                  <li>
                    <a href="/chapters/beginning/new-age.html">Новое время</a>
                  </li>
                </menu>
              </details>
              <details name="nav-chapter" open>
                <summary>Академия наук</summary>
                <menu>
                  <li>
                    <a href="/chapters/academy/foundation.html">Основание</a>
                  </li>
                  <li>
                    <a
                      aria-current="page"
                      href="/chapters/academy/numerical-methods/index.html"
                      >Численные методы</a
                    >
                  </li>
                  <li>
                    <a href="/chapters/academy/contribution.html">Вклад</a>
                  </li>
                </menu>
              </details>
              <details name="nav-chapter">
                <summary>Преемственность</summary>
                <menu>
                  <li>
                    <a href="/chapters/finale/legacy.html">Наследие Академии</a>
                  </li>
                  <li>
                    <a href="/chapters/finale/modern.html">Современность</a>
                  </li>
                  <li>
                    <a href="/chapters/finale/conclusion.html">Заключение</a>
                  </li>
                </menu>
              </details>
            </menu>
          </details>
        </li>
      </menu>
    </nav>
    <main>
      <article>
        <h2>Леонид Канторович</h2>
        <div class="frame">
          <p>
            Леонид Витальевич Канторович &mdash; советский математик и
            экономист, лауреат Нобелевской премии по экономике 1975 года
            &laquo;за вклад в теорию оптимального распределения ресурсов&raquo;.
          </p>
        </div>
        <div class="flex">
          <div style="flex: 200px 1 2">
            <img class="rounded" src="/static/img/kantorovich.png" />
          </div>
          <p style="flex: 50% 2 2">
            Леонид Канторович родился 19 января 1912 года в русской еврейской
            семье врачей, незадолго до того перебравшихся в Петербург из Вильны.
            С детства имеющий выдающиеся математические способности мальчик в
            1926 году в возрасте четырнадцати лет поступил в Ленинградский
            университет, окончив его в 1930 году.
          </p>
        </div>
        <p>
          В 1964 году избран академиком АН СССР. За разработку метода линейного
          программирования и экономических моделей удостоен в 1965 году
          Ленинской премии.
        </p>
      </article>
      <article>
        <h2>Линейное программирование</h2>
        <div class="info">
          <p>
            Линейное программирование позволяет решать задачи максимизации
            какого-либо значения (например, прибыли).
          </p>
        </div>
        <p>
          Допустим есть фабрика по производству сока: яблочного и апельсинового.
          На фабрике имеются ограниченные ресурсы: запас воды и время работы
          линий. Необходимо максимизировать прибыль
          <math display="inline"> <mi>P</mi> <mtext>,</mtext> </math> решив,
          сколько яблочного и апельсинового сока фабрика будет производить в
          день, не выходя при этом за рамки имеющихся ограничений. Это задача
          линейного программирования, потому что целевая функция (прибыль) и
          ограничения (ресурсы) выражаются линейными уравнениями.
        </p>
        <div class="frame">
          Если построить графики ограничений, то каждое неравенство поделит
          плоскость на две полуплоскости, а их пересечение (решение системы
          неравенств) образует многоугольник (в нашем случае &mdash;
          четырёхугольник). Ключевое открытие Канторовича заключается в том, что
          максимальное значение линейной функции (прибыли P) всегда достигается
          в одной из вершин многоугольника, образуемого областью допустимых
          решений.
        </div>
        <article>
          <h3>Пример</h3>
          <div class="flex column">
            <div>
              <h4>Переменные</h4>

              <button id="add-var">+</button>

              <template id="var-template">
                <div class="var">
                  <math display="inline">
                    <msub>
                      <mi>x</mi>
                      <mn></mn>
                    </msub>
                  </math>
                </div>
              </template>

              <div id="vars-container" class="flex"></div>
            </div>

            <div>
              <h4>Ограничения</h4>

              <template id="restriction-var-template">
                <span>
                  <input class="inline" type="number" />
                  &InvisibleTimes;
                  <label>
                    <math display="inline">
                      <msub> <mi>x</mi> <mn></mn> </msub>
                    </math>
                  </label>
                </span>
              </template>
              <template id="restriction-template">
                <div>
                  <span class="restriction-vars-container"></span>
                  &LessSlantEqual;
                  <input type="number" />
                </div>
              </template>

              <div id="restrictions-container" class="flex column"></div>
            </div>

            <div>
              <h4>Целевая функция</h4>

              <template id="objective-var-template">
                <span>
                  <input class="inline" type="number" />
                  &InvisibleTimes;
                  <label>
                    <math display="inline">
                      <msub> <mi>x</mi> <mn></mn> </msub>
                    </math>
                  </label>
                </span>
              </template>

              <div>
                <math display="inline">
                  <mi>P</mi>
                </math>
                =
                <span id="objective-container"> </span>
              </div>
            </div>

            <div>
              <h4>Результат</h4>

              <template id="result-var-template">
                <math display="block">
                  <msub> <mi>x</mi> <mn></mn> </msub>
                  <mo>&approx;</mo>
                  <mn></mn>
                </math>
              </template>

              <div id="results-container"></div>
            </div>
          </div>
        </article>
      </article>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/highs@1.8.0"></script>
    <script>
      const highsPromise = Module({
        locateFile: (file) => "https://lovasoa.github.io/highs-js/" + file,
      });

      const varsContainer = document.getElementById("vars-container");
      const restrictionsContainer = document.getElementById(
        "restrictions-container"
      );
      const objectiveContainer = document.getElementById("objective-container");
      const resultsContainer = document.getElementById("results-container");

      const varTemplate = document.getElementById("var-template");
      const restrictionTemplate = document.getElementById(
        "restriction-template"
      );
      const restrictionVarTemplate = document.getElementById(
        "restriction-var-template"
      );
      const objectiveVarTemplate = document.getElementById(
        "objective-var-template"
      );
      const resultVarTemplate = document.getElementById("result-var-template");

      const eventTarget = new EventTarget();

      let nextVarIndex = 1;
      function addVar() {
        eventTarget.dispatchEvent(
          new CustomEvent("addvar", { detail: nextVarIndex })
        );
        while (document.getElementById(`var-x${++nextVarIndex}`));
      }

      function removeVar(i) {
        if (document.getElementsByClassName("var").length > 2)
          eventTarget.dispatchEvent(
            new CustomEvent("removevar", { detail: i })
          );
      }

      document.getElementById("add-var").addEventListener("click", addVar);
      eventTarget.addEventListener("removevar", ({ detail: i }) => {
        if (nextVarIndex > i) nextVarIndex = i;
      });

      eventTarget.addEventListener("addvar", ({ detail: i }) => {
        const varClone = document.importNode(varTemplate.content, true);
        varClone.firstElementChild.id = `var-x${i}`;
        varClone.querySelector("mn").textContent = i;
        varClone.firstElementChild.addEventListener("click", () =>
          removeVar(i)
        );
        varsContainer.append(varClone);

        const objectiveVarClone = document.importNode(
          objectiveVarTemplate.content,
          true
        );
        objectiveVarClone.firstElementChild.id = `obj-var-x${i}`;
        objectiveVarClone.querySelector("mn").textContent = i;
        const objectiveInput = objectiveVarClone.querySelector("input");
        objectiveInput.id = objectiveVarClone.querySelector(
          "label"
        ).htmlFor = `obj-input-x${i}`;
        objectiveInput.addEventListener("input", handleInput);
        if (objectiveContainer.childElementCount > 0)
          objectiveVarClone.firstElementChild.prepend("+");
        objectiveContainer.append(objectiveVarClone);

        const resultVarClone = document.importNode(
          resultVarTemplate.content,
          true
        );
        resultVarClone.firstElementChild.id = `result-var-x${i}`;
        resultVarClone.querySelector("mn").textContent = i;
        resultsContainer.append(resultVarClone);
      });

      eventTarget.addEventListener("removevar", ({ detail: i }) => {
        document.getElementById(`var-x${i}`).remove();
        for (const element of Array.from(
          document.getElementsByClassName(`restriction-var-x${i}`)
        )) {
          if (!element.previousElementSibling)
            element.nextElementSibling?.firstChild.remove(); // remove `+`
          element.remove();
        }
        document.getElementById(`obj-var-x${i}`).remove();
        document.getElementById(`result-var-x${i}`).remove();
      });

      addVar();
      addVar();

      addRestriction();

      function addRestriction() {
        // TODO: allow changing inequality sign
        const restrictionClone = document.importNode(
          restrictionTemplate.content,
          true
        );
        const self = restrictionClone.firstElementChild;
        const restrictionVarsContainer = restrictionClone.querySelector(
          ".restriction-vars-container"
        );
        restrictionClone
          .querySelector("input")
          .addEventListener("input", updateRestriction);
        for (const element of document.getElementsByClassName("var")) {
          const [, i] = element.id.match(/^var-x(\d+)$/);
          addVar(i);
        }
        restrictionsContainer.append(restrictionClone);

        function onAddVar({ detail: i }) {
          addVar(i);
        }
        eventTarget.addEventListener("addvar", onAddVar);

        function addVar(i) {
          const restrictionVarClone = document.importNode(
            restrictionVarTemplate.content,
            true
          );
          restrictionVarClone.firstElementChild.className = `restriction-var-x${i}`;
          restrictionVarClone.querySelector("mn").textContent = i;
          restrictionVarClone
            .querySelector("input")
            .addEventListener("input", updateRestriction);
          if (restrictionVarsContainer.childElementCount > 0)
            restrictionVarClone.firstElementChild.prepend("+");
          restrictionVarsContainer.append(restrictionVarClone);
        }

        function updateRestriction() {
          if (
            Array.from(self.querySelectorAll("input")).every(
              (input) => !input.value
            )
          ) {
            if (self.previousElementSibling || self.nextElementSibling) {
              self.remove();
              eventTarget.removeEventListener("addvar", onAddVar);
            }
          } else {
            if (!self.nextElementSibling) addRestriction();
          }

          handleInput();
        }
      }

      let updateTimeout = undefined;
      function handleInput() {
        if (updateTimeout !== undefined) clearTimeout(updateTimeout);
        updateTimeout = setTimeout(update, 500);
      }

      async function update() {
        const highs = await highsPromise;

        let problem = "";

        problem += "Maximize\n obj: ";
        for (let i = 0; i < objectiveContainer.children.length; i++) {
          const element = objectiveContainer.children[i];

          const c = element.getElementsByTagName("input")[0].valueAsNumber;
          if (Number.isNaN(c)) return;
          if (c === 0) continue;
          if (i > 0 || c < 0) problem += (c > 0 ? "+" : "-") + " ";
          problem += Math.abs(c) + " ";

          const [, varName] = element.id.match(/^obj-var-(x\d+)$/);
          problem +=
            varName +
            (i === objectiveContainer.children.length - 1 ? "\n" : " ");
        }

        problem += "Subject To\n";
        for (let i = 0; i < restrictionsContainer.children.length; i++) {
          const restriction = restrictionsContainer.children[i];
          const inputs = restriction.querySelectorAll("input");
          const value = inputs[inputs.length - 1].value;
          if (!value) continue;

          problem += ` c${i}: `;

          const varsContainer = restriction.getElementsByClassName(
            "restriction-vars-container"
          )[0];
          for (let j = 0; j < varsContainer.children.length; j++) {
            const element = varsContainer.children[j];

            const c = element.getElementsByTagName("input")[0].valueAsNumber;
            if (Number.isNaN(c)) return;
            if (c === 0) continue;
            if (j > 0 || c < 0) problem += (c > 0 ? "+" : "-") + " ";
            problem += Math.abs(c) + " ";

            const [, varName] = element.className.match(
              /^restriction-var-(x\d+)$/
            );
            problem += varName + " ";
          }

          problem += "<= ";

          problem += value + "\n";
        }

        problem += "End\n";

        // TODO: handle errors and different statuses
        for (const [key, data] of Object.entries(
          highs.solve(problem).Columns
        )) {
          document
            .getElementById(`result-var-${key}`)
            .querySelectorAll("mn")[1].textContent = data.Primal;
        }
      }
    </script>
    <footer>
      <hr />
      <p>Вебсайт создан студентами <nobr>Колледжа Цифровых Технологий</nobr></p>
    </footer>
  </body>
</html>
